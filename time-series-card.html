<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-card/px-card.html"/>
<link rel="import" href="../px-chart/px-chart.html"/>
<script type="text/javascript" src="../px/dist/px.min.js"></script>

<dom-module id="time-series-card">
  <template>
    <px-card header-text="{{context.name}}">
      <!--<button on-click="saveBtnClicked">Save</button>-->
      <px-chart id="tsChart">
        <px-chart-controls data-controls show-refresh="true" show-date-range="true"></px-chart-controls>
        <px-chart-yaxis id="firstAxis" offset="0"></px-chart-yaxis>
        <px-chart-yaxis id="anotherAxis" opposite="true" offset="-2.5"></px-chart-yaxis>
        <px-chart-series-line id="fan-vibration-cruise" axis-id="anotherAxis" data="{{first}}"></px-chart-series-line>
      </px-chart>
    </px-card>
  </template>
</dom-module>
<script>

  Polymer({
    is: 'time-series-card',
    properties: {
      config: {
          type: Object
      }
    },
    init: function() {
      var self = this;
      /**
       * use the card's getData API method to fetch data, then pass that data into our time series widget
       * e.g. this.getData('http://predix-time-series-service').then(function(predixTimeSeriesData) {
       * In practice, this url will probably come through your context object.
       *
       * you can also use the px data transformer to convert from Predix TimeSeries data format to the expected timeseries data format
       * e.g. var timeSeriesChartData = new px.timeseries.dataTransformer().transform(predixTimeSeriesData.tags);
       *
       * sample time series data return from time series service
       */

      var pxTimeSeriesDataTransformer = new px.timeseries.dataTransformer();

      this.getData('/sample-data/fan-vibration-cruise.json').then(function(predixTimeSeriesData) {

        /**
         * you can also add a new series by adding px-chart-series-line component to the px-chart
         * and databind to {{secondSeries}} like the example above
         */
        self.first = pxTimeSeriesDataTransformer.transform(predixTimeSeriesData.tags)[0].data;
      });

      this.getData('/sample-data/delta-egt-cruise.json').then(function(predixTimeSeriesData) {

        var secondSeries = pxTimeSeriesDataTransformer.transform(predixTimeSeriesData.tags)[0];

        /**
         * you can add series programmatically using chart's addSeries api like below
         */
        secondSeries.id = secondSeries.name;
        secondSeries.axisId = "firstAxis";
        secondSeries.upperThreshold = "30.5";
        secondSeries.lowerThreshold = "6.25";
        self.$.tsChart.addSeries(secondSeries);
      });


      /**
       * on card initialization converts card config to chart widget's chartState property
       */
      if (this.config){
        this.$.tsChart.set('chartState', {chartZoom: self.config, srcElement: {}});
      }
    },
    saveBtnClicked: function(){
      /**
      * retrieve widget state from chart widget and assign it to card's config property
      * then execute save method which will turn all card's properties to card attribute object for saving back to view service
      */
      this.config = this.$.tsChart.chartState.chartZoom;
      this.save();
    },
    behaviors: [px.card]
  });
</script>
